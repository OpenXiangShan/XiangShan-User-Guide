---
file_authors_:
- zengjinhong <zengjinhong21@mails.ucas.ac.cn>
---

# Exception and Interrupt {#sec:exception-and-interrupt}

## Overview

Exceptions and interrupts are mechanisms by which the processor jumps from the
normal program execution flow to privileged mode. They are used to handle
various unexpected or anticipated events. These mechanisms help the processor
address issues encountered during execution, maintain system stability, and
respond to external events.

* An exception refers to a situation where the processor encounters an issue
  while executing the current instruction that prevents further execution,
  requiring an immediate halt to the normal program flow and entry into an
  exception handler. Exceptions are typically synchronous, meaning they are
  directly related to the currently executing instruction. Common types of
  exceptions include:

  1. Illegal instruction: When the processor encounters an unrecognizable or
     unexecutable instruction, it generates an illegal instruction exception.
  2. Address misaligned exception: When performing load or store operations, if
     the accessed memory address is misaligned, the processor will raise an
     exception.
  3. Page fault: In a virtual memory system, a page fault exception occurs when
     a page table entry is missing or memory access permissions are
     insufficient.
  4. Environment call (system call): When an application requests kernel
     services through a specific instruction, it also triggers an exception.
  5. Hardware Error: When the processor executes a load or store operation and
     the bus address request corresponds to data that does not exist, the
     processor triggers an exception.
  6. Double Trap: When the processor is executing an exception/interrupt handler
     and another exception/interrupt occurs, the processor triggers an exception
     to handle the double trap.
* An interrupt is a signal triggered by external hardware devices (such as
  timers, peripherals, etc.), requesting the processor to pause the currently
  executing program and handle these external events. Interrupts are
  asynchronous, meaning they are unrelated to the current instruction execution
  and can occur at any time. Based on their sources, interrupts can be
  categorized into the following types:

  1. Hardware interrupts: Generated by external hardware devices, such as I/O
     requests from peripherals, timer interrupts, etc.
  2. Software interrupts: Triggered by software for interacting with the
     operating system or performing certain system-level tasks.
* A trap is a mechanism where the processor switches from user mode or a lower
  privilege level to a privileged mode (such as kernel mode) to handle events.
  The processor captures exceptions or interrupts through the trap mechanism,
  saves context information, and jumps to the corresponding handler. After
  processing is complete, the processor restores the previous execution state
  via return instructions (such as mret or sret) and continues executing the
  original program.

## Exception

{{processor_name}} supports various exceptions, as shown in the following table:

Table: List of exceptions supported by {{processor_name}}

| Exception number |                         Trap cause                         |       tval update value       |            tval2 update value            |
| :--------------: | :--------------------------------------------------------: | :---------------------------: | :--------------------------------------: |
|        0         |               Instruction address misaligned               |               0               |                    0                     |
|        1         | Instruction fetch permission exception (non-page-crossing) |            指令起始地址             |                    0                     |
|        1         |      Instruction fetch permission fault (cross-page)       |            下一页首地址             |                    0                     |
|        2         |                    Illegal instruction                     |            非法指令编码             |                    0                     |
|        3         |                         Breakpoint                         | Exception instruction address |                    0                     |
|        3         |                     EBREAK instruction                     |               0               |                    0                     |
|        4         |                  LOAD address misaligned                   |            访存的起始地址            |                    0                     |
|        5         |                 LOAD Permission Exception                  |        实际 fault 的起始地址         |                    0                     |
|        6         |                STORE/AMO Address Misaligned                |            访存的起始地址            |                    0                     |
|        7         |               STORE/AMO permission exception               |        实际 fault 的起始地址         |                    0                     |
|        8         |                          U-ECALL                           |               0               |                    0                     |
|        9         |                          S-ECALL                           |               0               |                    0                     |
|        10        |                          VS-ECALL                          |               0               |                    0                     |
|        11        |                          M-ECALL                           |               0               |                    0                     |
|        12        |         Instruction Page Fault (Non-page-crossing)         |            指令起始地址             |                    0                     |
|        12        |           Instruction page fault (page-crossing)           |            下一页首地址             |                    0                     |
|        13        |              LOAD page fault (non-cross-page)              |            访存的起始地址            |                    0                     |
|        13        |              LOAD page fault (page-crossing)               |        实际 fault 的起始地址         |                    0                     |
|        15        |          STORE/AMO Page Fault (Non-page-crossing)          |            访存的起始地址            |                    0                     |
|        15        |             STORE/AMO page fault (cross-page)              |        实际 fault 的起始地址         |                    0                     |
|        16        |                   Double Trap Exception                    |               0               | Trap cause code of the second exception. |
|        19        |                       Hardware error                       |        实际 fault 的起始地址         |                    0                     |
|        20        |      Guest instruction page fault (non-page-crossing)      |            指令起始地址             |                 对应的 GPA                  |
|        20        |         Guest instruction page fault (cross-page)          |            下一页首地址             |              实际 fault 的 GPA              |
|        21        |           Guest LOAD page fault (non-cross-page)           |            访存的起始地址            |                 对应的 GPA                  |
|        21        |             Guest LOAD page fault (cross-page)             |        实际 fault 的起始地址         |              实际 fault 的 GPA              |
|        22        |            Virtualization instruction exception            |            非法指令编码             |                    0                     |
|        23        |       Guest STORE/AMO page fault (non-page-crossing)       |            访存的起始地址            |                 对应的 GPA                  |
|        23        |          Guest STORE/AMO Page Fault (Cross-page)           |        实际 fault 的起始地址         |              实际 fault 的 GPA              |

Note: Xiangshan does not actually have instruction address misalignment
exceptions.

We take machine mode as an example to introduce the steps of exception handling.

### Exception Response

Step 1: The processor saves the PC where the exception occurred into mepc.

Step 2: Set the interrupt flag bit of mcause to 0, write the exception number
into mcause, and modify the corresponding mtval.

Step 3: Save the MIE bit of mstatus to the MPIE bit, then clear the MIE bit. Set
the MPV bit and MPP bit of mstatus to the current Virtual Mode and Privilege
Mode respectively, and modify the corresponding GVA bit as needed.

Step 4: Fetch and execute the corresponding instruction based on mtvec.

### Exception return

Exception return is implemented via the mret instruction, which performs the
following operations.

* Restore PC based on mepc.
* Restore the MIE bit of mstatus according to the MPIE bit of mstatus.
* Change the current Privilege Mode to the MPP bit of mstatus, and if the MPP
  bit is machine mode, set the Virtual Mode to 0; otherwise, set it to the MPV
  bit of mstatus.

## Interrupts.

{{processor_name}} supports various interrupts, as shown in the following table:

Table: {{processor_name}} Supported Interrupt List

| Interrupt number |                  Trap cause                  |
| :--------------: | :------------------------------------------: |
|        1         |     Supervisor Software Interrupt (SSI)      |
|        2         | Virtual Supervisor Software Interrupt (VSSI) |
|        3         |    Machine-mode Software Interrupt (MSI)     |
|        5         |    Supervisor mode timer interrupt (STI)     |
|        6         |  Virtual Supervisor Timer Interrupt (VSTI)   |
|        7         |      Machine mode timer interrupt (MTI)      |
|        9         |   Supervisor mode external interrupt (SEI)   |
|        10        | Virtual Supervisor External Interrupt (VSEI) |
|        11        |    Machine-mode external interrupt (MEI)     |
|        12        |  Supervisor Guest External Interrupt (SGEI)  |
|        13        |  Local Counter Overflow Interrupt (LCOFIP)   |
|      16-23       |                    标准本地中断                    |
|      24-31       |                    自定义中断                     |
|      32-47       |                    标准本地中断                    |
|      48-63       |                    自定义中断                     |

We use machine mode as an example to explain the steps of interrupt handling

### 中断优先级

The interrupt priorities of {{processor_name}} are as shown in the following
table:

Table: {{processor_name}} Interrupt Priorities

|  中断优先级  |     Group      | Number     | Descrption                                                    |
| :-----: | :------------: | ---------- | ------------------------------------------------------------- |
| Highest | Custom Group 0 | 63, 31, 62 | Highest Priority Custom Interrupt                             |
|         |                | 61, 30, 60 |                                                               |
|         | Local Group 0  | 47, 23, 46 | High-priority Local interrupt                                 |
|         |                | 45, 22, 44 |                                                               |
|         |                | 43, 21, 42 |                                                               |
|         |                | 41, 20, 40 |                                                               |
|         | Custom Group 1 | 59, 29, 58 | Second highest priority Custom interrupt                      |
|         |                | 57, 28, 56 |                                                               |
|         |   TSEO Group   | 11, 3, 7   | Machine Mode Interrupts: External, Software, Timer            |
|         |                | 9, 1, 5    | Supervisor Mode Interrupts: External, Software, Timer         |
|         |                | 12         | Supervisor Guest External Interrupt                           |
|         |                | 10, 2, 6   | Virtual Supervisor Mode Interrupts: External, Software, Timer |
|         |                | 13         | Local counter overflow interrupt                              |
|         | Custom Group 2 | 55, 27, 54 | Medium Priority Custom Interrupt                              |
|         |                | 53, 26, 52 |                                                               |
|         | Local Group 1  | 39, 19, 38 | Low-priority Local interrupt                                  |
|         |                | 37, 18, 36 |                                                               |
|         |                | 35, 17, 34 |                                                               |
|         |                | 33, 16, 32 |                                                               |
|         | Custom Group 3 | 51, 25, 50 | Lowest priority Custom interrupt                              |
| Lowest  |                | 49, 24, 48 |                                                               |

### Interrupt Response

Step 1: After executing the current instruction, the processor stores the PC of
the next instruction into mepc.

Step 2: Set the interrupt flag bit of mcause to 1, write the exception number
into mcause, and set mtval to 0.

Step 3: Save the MIE bit of mstatus to the MPIE bit, then clear the MIE bit. Set
the MPV bit and MPP bit of mstatus to the current Virtual Mode and Privilege
Mode respectively, and modify the corresponding GVA bit as needed.

Step 4: Fetch and execute the corresponding instruction based on mtvec.

### Interrupt return

* Restore PC based on mepc.
* Restore the MIE bit of mstatus according to the MPIE bit of mstatus.
* Change the current Privilege Mode to the MPP bit of mstatus, and if the MPP
  bit is machine mode, set the Virtual Mode to 0; otherwise, set it to the MPV
  bit of mstatus.
