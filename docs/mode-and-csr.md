---
file_authors_:
- zengjinhong <zengjinhong21@mails.ucas.ac.cn>
---
## 处理器模式与控制寄存器

### 处理器模式

{{var_processor_name}} 支持 RISC-V 特权架构手册规定的以下 5 种特权模式。

Table: {{var_processor_name}} 支持的特权级列表

| 名称                                    | 缩写 | PRIV | V |
| --------------------------------------- | :--: | :--: | :-: |
| 机器模式（Machine mode）                |  M  |  3  | 0 |
| 监管模式（Supervisor mode）             | HS/S |  1  | 0 |
| 用户模式（User mode）                   |  U  |  0  | 0 |
| 虚拟监管模式（Virtual supervisor mode） |  VS  |  1  | 1 |
| 虚拟用户模式（Virtual user mode）       |  VU  |  0  | 1 |

当 V 关闭时，{{var_processor_name}} 支持 RISC-V 的三种特权模式：Machine-mode（机器模式）、Supervisor-mode（监管模式）以及 User-mode（用户模式）（在下面分别称为 M 模式，S 模式，U 模式）。三种模式在对寄存器的访问、特权指令的使用、内存空间的访问上存在区别，其中 M 模式的权限最高，U 模式的权限最低。{{var_processor_name}} 初始化时处在 M 模式。

* U 模式：该模式下通常运行常规应用程序，只能访问指定给普通用户模式的寄存器，避免其接触特权信息。
* S 模式：该模式下通常运行操作系统，它可以访问除了机器模式的寄存器以外的寄存器，它协同调度常规用户程序，为它们提供管理与服务。
* M 模式：该模式拥有最高权限，拥有所有资源的使用权。

当 V 开启时，{{var_processor_name}} 支持 H 扩展，此时具有四种特权模式：Machine-mode（机器模式）、Hyervisor-mode（虚拟机监管模式）、Virtual-supervisor-mode（虚拟监管模式）、Virtual-user-mode（虚拟用户模式），其中权限高低为，M > HS > VS > VU。

### 控制和状态寄存器（Control and Status Registers）

我们将以权限的不同对控制和状态寄存器（CSRs）进行分组介绍。

#### 用户模式可读写的 CSRs

{{var_processor_name}} 中实现的权限为用户模式可读写（URW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 URW 的 CSRs 列表

|  名称  | 特权级 | 编号 |          描述          |    组别    |
| :----: | :----: | :---: | :--------------------: | :--------: |
| fflags |   U   | 0x001 | 浮点异常累积状态寄存器 | 非特权浮点 |
|  frm  |   U   | 0x002 | 浮点动态舍入模式寄存器 | 非特权浮点 |
|  fcsr  |   U   | 0x003 |  浮点控制和状态寄存器  | 非特权浮点 |
| vstart |   U   | 0x008 |   向量起始位置寄存器   | 非特权向量 |
| vxsat |   U   | 0x009 |  定点溢出标志位寄存器  | 非特权向量 |
|  vxrm  |   U   | 0x00A |   定点舍入模式寄存器   | 非特权向量 |
|  vcsr  |   U   | 0x00F |  向量控制和状态寄存器  | 非特权向量 |
|   vl   |   U   | 0xC20 |     向量长度寄存器     | 非特权向量 |
| vtype |   U   | 0xC21 |   向量数据类型寄存器   | 非特权向量 |
| vlenb |   U   | 0xC22 | 向量寄存器字节数寄存器 | 非特权向量 |

#### 用户模式只读的 CSRs

{{var_processor_name}} 中实现的权限为用户模式只读（URO）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 URO 的 CSRs 列表

|     名称     | 特权级 | 编号 |          描述          |      组别      |
| :----------: | :----: | :---: | :--------------------: | :------------: |
|    cycle    |   U   | 0xC00 |   用户模式周期计数器   | 用户模式计数器 |
|     time     |   U   | 0xC01 |   用户模式时间计数器   | 用户模式计数器 |
|   instret   |   U   | 0xC02 | 用户模式退休指令计数器 | 用户模式计数器 |
| hpmcounter3 |   U   | 0xC03 |    用户模式计数器3    | 用户模式计数器 |
|     ...     |  ...  |  ...  |          ...          |      ...      |
| hpmcounter31 |   U   | 0xC1F |    用户模式计数器31    | 用户模式计数器 |

#### 监管模式可读写的 CSRs

{{var_processor_name}} 中实现的权限为监管模式可读写（SRW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 SRW 的 CSRs 列表

|    名称    | 特权级 | 编号 |               描述               |        组别        |
| :--------: | :-----: | :---: | :------------------------------: | :----------------: |
|  sstatus  |    S    | 0x100 |     监管模式处理器状态寄存器     |    监管陷入设置    |
|    sie    |    S    | 0x104 |    监管模式中断使能控制寄存器    |    监管陷入设置    |
|   stvec   |    S    | 0x105 |      监管模式向量基址寄存器      |    监管陷入设置    |
| scounteren |    S    | 0x106 |   监管模式计数器使能控制寄存器   |    监管陷入设置    |
|  senvcfg  |    S    | 0x10A |      监管模式环境配置寄存器      |    监管环境配置    |
|  sscratch  |    S    | 0x140 |  监管模式陷入临时数据备份寄存器  |    监管陷入处理    |
|    sepc    |    S    | 0x141 |    监管模式陷入保留程序计数器    |    监管陷入处理    |
|   scause   |    S    | 0x142 |    监管模式陷入事件原因寄存器    |    监管陷入处理    |
|   stval   |    S    | 0x143 |    监管模式陷入事件向量寄存器    |    监管陷入处理    |
|    sip    |    S    | 0x144 |  监管模式陷入事件等待状态寄存器  |    监管陷入处理    |
|  stimecmp  |    S    | 0x14D |  监管模式计时器中断比较值寄存器  |    监管陷入设置    |
|  siselect  |    S    | 0x150 | 监管模式间接寄存器选择信号寄存器 | 监管间接访问寄存器 |
|   sireg   |    S    | 0x151 |   监管模式间接寄存器别名寄存器   | 监管间接访问寄存器 |
|   stopei   |    S    | 0x15C |    监管模式顶部外部中断寄存器    |      监管中断      |
|    satp    |    S    | 0x180 | 监管模式虚拟地址转换和保护寄存器 |   监管保护和转换   |
|  scontext  | S/Debug | 0x5A8 |       监管模式上下文寄存器       |     调试寄存器     |

#### 监管模式只读的 CSRs

{{var_processor_name}} 中实现的权限为监管模式只读（SRO）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 SRO 的 CSRs 列表

| 名称 | 特权级 | 编号 |       描述       |   组别   |
| :---: | :----: | :---: | :--------------: | :------: |
| stopi |   S   | 0xDB0 | 监管模式顶层中断 | 监管中断 |

#### 虚拟监管模式可读写的 CSRs

{{var_processor_name}} 中实现的权限为虚拟监管模式可读写（HRW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 HRW 的 CSRs 列表

|    名称    |  特权级  | 编号 |                 描述                 |          组别          |
| :--------: | :------: | :---: | :----------------------------------: | :--------------------: |
|  vsstatus  |    VS    | 0x200 |     虚拟监管模式处理器状态寄存器     |        虚拟监管        |
|    vsie    |    VS    | 0x204 |    虚拟监管模式中断使能控制寄存器    |        虚拟监管        |
|   vstvec   |    VS    | 0x205 |      虚拟监管模式向量基址寄存器      |        虚拟监管        |
| vsscratch |    VS    | 0x240 |  虚拟监管模式陷入临时数据备份寄存器  |        虚拟监管        |
|   vsepc   |    VS    | 0x241 |    虚拟监管模式陷入保留程序计数器    |        虚拟监管        |
|  vscause  |    VS    | 0x242 |    虚拟监管模式陷入事件原因寄存器    |        虚拟监管        |
|   vstval   |    VS    | 0x243 |    虚拟监管模式陷入事件向量寄存器    |        虚拟监管        |
|    vsip    |    VS    | 0x244 |  虚拟监管模式陷入事件等待状态寄存器  |        虚拟监管        |
| vstimecmp |    VS    | 0x24D |  虚拟监管模式计时器中断比较值寄存器  |        虚拟监管        |
| vsiselect |    VS    | 0x250 | 虚拟监管模式间接寄存器选择信号寄存器 | 虚拟监管间接访问寄存器 |
|   vsireg   |    VS    | 0x251 |   虚拟监管模式间接寄存器别名寄存器   | 虚拟监管间接访问寄存器 |
|  vstopei  |    VS    | 0x25C |    虚拟监管模式顶部外部中断寄存器    |      虚拟监管中断      |
|   vsatp   |    VS    | 0x280 | 虚拟监管模式虚拟地址转换和保护寄存器 |        虚拟监管        |
|  hstatus  |    HS    | 0x600 |      虚拟机模式处理器状态寄存器      |     虚拟机陷入设置     |
|  hedeleg  |    HS    | 0x602 |     虚拟机模式陷入降级控制寄存器     |     虚拟机陷入设置     |
|  hideleg  |    HS    | 0x603 |     虚拟机模式中断降级控制寄存器     |     虚拟机陷入设置     |
|    hie    |    HS    | 0x604 |       虚拟机模式中断使能寄存器       |     虚拟机陷入设置     |
| htimedelta |    HS    | 0x605 |        虚拟机模式虚拟化计时器        |      虚拟机计时器      |
| hcounteren |    HS    | 0x606 |      虚拟机模式计数器使能寄存器      |     虚拟机陷入设置     |
|   hgeie   |    HS    | 0x607 |  虚拟机模式客户机外部中断启用寄存器  |     虚拟机陷入设置     |
|   hvien   |    HS    | 0x608 |     虚拟机模式虚拟中断使能寄存器     |     虚拟机陷入设置     |
|   hvictl   |    HS    | 0x609 |     虚拟机模式虚拟中断控制寄存器     |     虚拟机陷入设置     |
|  henvcfg  |    HS    | 0x60A |       虚拟机模式环境配置寄存器       |       虚拟机配置       |
|   htval   |    HS    | 0x643 |     虚拟机模式陷入事件向量寄存器     |     虚拟机陷入处理     |
|    hip    |    HS    | 0x644 |   虚拟机模式陷入事件等待状态寄存器   |     虚拟机陷入处理     |
|    hvip    |    HS    | 0x645 |     虚拟机模式虚拟中断挂起寄存器     |     虚拟机陷入处理     |
|  hviprio1  |    HS    | 0x646 | 虚拟机模式VS-Level中断优先级寄存器1 |     虚拟机陷入处理     |
|  hviprio2  |    HS    | 0x647 | 虚拟机模式VS-Level中断优先级寄存器2 |     虚拟机陷入处理     |
|   htinst   |    HS    | 0x64A |       虚拟机模式陷入指令寄存器       |     虚拟机陷入处理     |
|   hgatp   |    HS    | 0x680 |  虚拟机模式客户地址转换和保护寄存器  |    虚拟机保护和转换    |
|  hcontext  | HS/Debug | 0x6A8 |        虚拟机模式上下文寄存器        |       调试寄存器       |

#### 虚拟监管模式只读的 CSRs

{{var_processor_name}} 中实现的权限为虚拟监管模式只读（HRO）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 HRO 的 CSRs 列表

|  名称  | 特权级 | 编号 |                描述                |      组别      |
| :----: | :----: | :---: | :--------------------------------: | :------------: |
| hgeip |   HS   | 0xE12 | 虚拟机模式客户机外部中断挂起寄存器 | 虚拟机陷入处理 |
| vstopi |   VS   | 0xEB0 |        虚拟监管模式顶层中断        | 虚拟监管级中断 |

#### 机器模式可读写的 CSRs

{{var_processor_name}} 中实现的权限为机器模式可读写（MRW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 MRW 的 CSRs 列表

|     名称     | 特权级 | 编号 |                  描述                  |         组别         |
| :-----------: | :-----: | :---: | :------------------------------------: | :------------------: |
|    mstatus    |    M    | 0x300 |        机器模式处理器状态寄存器        |     机器陷入设置     |
|     misa     |    M    | 0x301 |       机器模式处理器指令集寄存器       |     机器陷入设置     |
|    medeleg    |    M    | 0x302 |       机器模式陷入降级控制寄存器       |     机器陷入设置     |
|    mideleg    |    M    | 0x303 |       机器模式中断降级控制寄存器       |     机器陷入设置     |
|      mie      |    M    | 0x304 |         机器模式中断使能寄存器         |     机器陷入设置     |
|     mtvec     |    M    | 0x305 |         机器模式向量基址寄存器         |     机器陷入设置     |
|  mcounteren  |    M    | 0x306 |        机器模式计数器使能寄存器        |     机器陷入设置     |
|     mvien     |    M    | 0x308 |       机器模式虚拟中断使能寄存器       |     机器陷入设置     |
|     mvip     |    M    | 0x309 |       机器模式虚拟中断挂起寄存器       |     机器陷入设置     |
|    menvcfg    |    M    | 0x30A |         机器模式环境配置寄存器         |       机器配置       |
|   mstateen0   |    M    | 0x30C |         机器模式状态使能寄存器         |   机器状态使能扩展   |
| mcountinhibit |    M    | 0x320 |         机器模式计数禁止寄存器         |    机器计数器配置    |
|  mhpmevent3  |    M    | 0x323 |    机器模式性能监测事件选择寄存器3    |    机器计数器配置    |
|      ...      |   ...   |  ...  |                  ...                  |         ...         |
|  mhpmevent31  |    M    | 0x33F |    机器模式性能监测事件选择寄存器31    |    机器计数器配置    |
|   mscratch   |    M    | 0x340 |     机器模式陷入临时数据备份寄存器     |     机器陷入处理     |
|     mepc     |    M    | 0x341 |       机器模式陷入保留程序计数器       |     机器陷入处理     |
|    mcause    |    M    | 0x342 |       机器模式陷入事件原因寄存器       |     机器陷入处理     |
|     mtval     |    M    | 0x343 |       机器模式陷入事件向量寄存器       |     机器陷入处理     |
|      mip      |    M    | 0x344 |     机器模式陷入事件等待状态寄存器     |     机器陷入处理     |
|    mtinst    |    M    | 0x34A |         机器模式陷入指令寄存器         |     机器陷入处理     |
|    mtval2    |    M    | 0x34B |      机器模式陷入事件向量寄存器2      |     机器陷入处理     |
|   miselect   |    M    | 0x350 |    机器模式间接寄存器选择信号寄存器    |  机器间接访问寄存器  |
|     mireg     |    M    | 0x351 |      机器模式间接寄存器别名寄存器      |  机器间接访问寄存器  |
|    mtopei    |    M    | 0x35C |       机器模式顶部外部中断寄存器       |       机器中断       |
|    pmpcfg0    |    M    | 0x3A0 |        物理内存保护配置寄存器0        |     机器内存保护     |
|    pmpcfg2    |    M    | 0x3A2 |        物理内存保护配置寄存器2        |     机器内存保护     |
|      ...      |   ...   |  ...  |                  ...                  |         ...         |
|   pmpcfg14   |    M    | 0x3AE |        物理内存保护配置寄存器14        |     机器内存保护     |
|   pmpaddr0   |    M    | 0x3B0 |        物理内存保护基址寄存器0        |     机器内存保护     |
|      ...      |   ...   |  ...  |                  ...                  |         ...         |
|   pmpaddr63   |    M    | 0x3EF |        物理内存保护基址寄存器63        |     机器内存保护     |
|   mnscratch   |    M    | 0x740 | 机器模式不可屏蔽中断临时数据备份寄存器 | 机器不可屏蔽中断处理 |
|     mnepc     |    M    | 0x741 |   机器模式不可屏蔽中断保留程序计数器   | 机器不可屏蔽中断处理 |
|    mncause    |    M    | 0x742 |   机器模式不可屏蔽中断事件原因寄存器   | 机器不可屏蔽中断处理 |
|   mnstatus   |    M    | 0x744 |    机器模式不可屏蔽处理器状态寄存器    | 机器不可屏蔽中断处理 |
|    mseccfg    |    M    | 0x747 |         机器模式安全配置寄存器         |       机器配置       |
|    tselect    | M/Debug | 0x7A0 |      Debug/Trace 触发器选择寄存器      |      调试寄存器      |
|    tdata1    | M/Debug | 0x7A1 |  第一个 Debug/Trace 触发器数据寄存器  |      调试寄存器      |
|    tdata2    | M/Debug | 0x7A2 |  第二个 Debug/Trace 触发器数据寄存器  |      调试寄存器      |
|    tdata3    | M/Debug | 0x7A3 |  第三个 Debug/Trace 触发器数据寄存器  |      调试寄存器      |
|     tinfo     | M/Debug | 0x7A4 |      Debug/Trace 触发器信息寄存器      |      调试寄存器      |
|   tcontrol   | M/Debug | 0x7A2 |        机器模式除法器使能寄存器        |      调试寄存器      |
|   mcontext   | M/Debug | 0x7A3 |          机器模式上下文寄存器          |      调试寄存器      |
|    pmacfg0    |    M    | 0x7C0 |             PMA配置寄存器0             |       PMA配置       |
|    pmacfg2    |    M    | 0x7C2 |             PMA配置寄存器2             |       PMA配置       |
|   pmaaddr0   |    M    | 0x7C8 |             PMA地址寄存器0             |       PMA地址       |
|      ...      |   ...   |  ...  |                  ...                  |         ...         |
|   pmaaddr15   |    M    | 0x7D7 |            PMA地址寄存器15            |       PMA地址       |
|    mcycle    |    M    | 0xB00 |           机器模式周期计数器           |      机器计数器      |
|   minstret   |    M    | 0xB02 |         机器模式退役指令计数器         |      机器计数器      |
| mhpmcounter3 |    M    | 0xB03 |        机器模式性能监测计数器3        |      机器计数器      |
|      ...      |   ...   |  ...  |                  ...                  |         ...         |
| mhpmcounter31 |    M    | 0xB1F |        机器模式性能监测计数器31        |      机器计数器      |

#### 机器模式只读的 CSRs

{{var_processor_name}} 中实现的权限为机器模式只读（MRO）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 MRO 的 CSRs 列表

|    名称    | 特权级 | 编号 |            描述            |     组别     |
| :--------: | :----: | :---: | :------------------------: | :----------: |
| mvendorid |   M   | 0xF11 |      供应商编号寄存器      |   机器信息   |
|  marchid  |   M   | 0xF12 |       架构编号寄存器       |   机器信息   |
|   mimpid   |   M   | 0xF13 | 机器模式硬件实现编号寄存器 |   机器信息   |
|  mhartid  |   M   | 0xF14 | 机器模式逻辑内核编号寄存器 |   机器信息   |
| mconfigptr |   M   | 0xF15 |      配置数据结构指针      |   机器信息   |
|   mtopi   |   M   | 0xFB0 |      机器模式顶层中断      | 机器陷入设置 |

#### 调试模式可读写的 CSRs

{{var_processor_name}} 中实现的权限为调试模式可读写（DRW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 DRW 的 CSRs 列表

|   名称   | 特权级 | 编号 |           描述           |      组别      |
| :-------: | :----: | :---: | :----------------------: | :------------: |
|   dcsr   | Debug | 0x7B0 | 调试模式控制与状态寄存器 | 调试模式寄存器 |
|    dpc    | Debug | 0x7B1 |    调试模式程序计数器    | 调试模式寄存器 |
| dscratch0 | Debug | 0x7B2 |   调试模式暂存寄存器0   | 调试模式寄存器 |
| dscratch1 | Debug | 0x7B3 |   调试模式暂存寄存器1   | 调试模式寄存器 |
