---
file_authors_:
- zengjinhong <zengjinhong21@mails.ucas.ac.cn>
---
## 处理器模式与控制寄存器

### 处理器模式

{{var_processor_name}} 支持 RISC-V 特权架构手册规定的以下 5 种特权模式。

Table: {{var_processor_name}} 支持的特权级列表

| 名称                                    | 缩写 | PRIV | V |
| --------------------------------------- | :--: | :--: | :-: |
| 机器模式（Machine mode）                |  M  |  3  | 0 |
| 监管模式（Supervisor mode）             | HS/S |  1  | 0 |
| 用户模式（User mode）                   |  U  |  0  | 0 |
| 虚拟监管模式（Virtual supervisor mode） |  VS  |  1  | 1 |
| 虚拟用户模式（Virtual user mode）       |  VU  |  0  | 1 |

当 V 关闭时，{{var_processor_name}} 支持 RISC-V 的三种特权模式：Machine-mode（机器模式）、Supervisor-mode（监管模式）以及 User-mode（用户模式）（在下面分别称为 M 模式，S 模式，U 模式）。三种模式在对寄存器的访问、特权指令的使用、内存空间的访问上存在区别，其中 M 模式的权限最高，U 模式的权限最低。{{var_processor_name}} 初始化时处在 M 模式。

* U 模式：该模式下通常运行常规应用程序，只能访问指定给普通用户模式的寄存器，避免其接触特权信息。
* S 模式：该模式下通常运行操作系统，它可以访问除了机器模式的寄存器以外的寄存器，它协同调度常规用户程序，为它们提供管理与服务。
* M 模式：该模式拥有最高权限，拥有所有资源的使用权。

当 V 开启时，{{var_processor_name}} 支持 H 扩展，此时具有四种特权模式：Machine-mode（机器模式）、Hyervisor-mode（虚拟机监管模式）、Virtual-supervisor-mode（虚拟监管模式）、Virtual-user-mode（虚拟用户模式），其中权限高低为，M > HS > VS > VU。

### 控制和状态寄存器（Control and Status Registers）

我们将以权限的不同对控制和状态寄存器（CSRs）进行分组介绍。

{{var_processor_name}} 中实现的权限为用户模式可读写（URW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 URW 的 CSRs 列表

| 名称   | 特权级 | 编号 |          描述          | 组别       |
| ------ | :----: | :---: | :--------------------: | ---------- |
| fflags |   U   | 0x001 | 浮点异常累积状态寄存器 | 非特权浮点 |
| frm    |   U   | 0x002 | 浮点动态舍入模式寄存器 | 非特权浮点 |
| fcsr   |   U   | 0x003 |  浮点控制和状态寄存器  | 非特权浮点 |
| vstart |   U   | 0x008 |   向量起始位置寄存器   | 非特权向量 |
| vxsat  |   U   | 0x009 |  定点溢出标志位寄存器  | 非特权向量 |
| vxrm   |   U   | 0x00A |   定点舍入模式寄存器   | 非特权向量 |
| vcsr   |   U   | 0x00F |  向量控制和状态寄存器  | 非特权向量 |
| vl     |   U   | 0xC20 |     向量长度寄存器     | 非特权向量 |
| vtype  |   U   | 0xC21 |   向量数据类型寄存器   | 非特权向量 |
| vlenb  |   U   | 0xC22 | 向量寄存器字节数寄存器 | 非特权向量 |

{{var_processor_name}} 中实现的权限为用户模式只读（URO）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 URO 的 CSRs 列表

|     名称     | 特权级 | 编号 |          描述          |      组别      |
| :----------: | :----: | :---: | :--------------------: | :------------: |
|    cycle    |   U   | 0xC00 |   用户模式周期计数器   | 用户模式计数器 |
|     time     |   U   | 0xC01 |   用户模式时间计数器   | 用户模式计数器 |
|   instret   |   U   | 0xC02 | 用户模式退休指令计数器 | 用户模式计数器 |
| hpmcounter3 |   U   | 0xC03 |    用户模式计数器3    | 用户模式计数器 |
|     ...     |  ...  |  ...  |          ...          |      ...      |
| hpmcounter31 |   U   | 0xC1F |    用户模式计数器31    | 用户模式计数器 |

{{var_processor_name}} 中实现的权限为监管模式可读写（SRW）的 RISC-V 的 CSRs 如下表所示：

Table: {{var_processor_name}} 支持的 SRW 的 CSRs 列表

| 名称       | 特权级 | 编号 |               描述               | 组别               |
| ---------- | :----: | :---: | :------------------------------: | ------------------ |
| sstatus    |   S   | 0x100 |     监管模式处理器状态寄存器     | 监管陷入设置       |
| sie        |   S   | 0x104 |    监管模式终端使能控制寄存器    | 监管陷入设置       |
| stvec      |   S   | 0x105 |      监管模式向量基址寄存器      | 监管陷入设置       |
| scounteren |   S   | 0x106 |   监管模式计数器使能控制寄存器   | 监管陷入设置       |
| senvcfg    |   S   | 0x10A |      监管模式环境配置寄存器      | 监管环境配置       |
| sscratch   |   S   | 0x140 |  监管模式异常临时数据备份寄存器  | 监管陷入处理       |
| sepc       |   S   | 0x141 |    监管模式异常保留程序计数器    | 监管陷入处理       |
| scause     |   S   | 0x142 |    监管模式异常事件原因寄存器    | 监管陷入处理       |
| stval      |   S   | 0x143 |    监管模式异常事件向量寄存器    | 监管陷入处理       |
| sip        |   S   | 0x144 |  监管模式异常事件等待状态寄存器  | 监管陷入处理       |
| stimecmp   |   S   | 0x14D |  监管模式计时器中断比较值寄存器  | 监管陷入设置       |
| siselect   |   S   | 0x150 | 监管模式间接寄存器选择信号寄存器 | 监管间接访问寄存器 |
| sireg      |   S   | 0x151 |   监管模式间接寄存器别名寄存器   | 监管间接访问寄存器 |
| stopei     |   S   | 0x15C |    监管模式顶部外部中断寄存器    | 监管中断           |
| satp       |   S   | 0x180 | 监管模式虚拟地址转换和保护寄存器 | 监管保护和转换     |
